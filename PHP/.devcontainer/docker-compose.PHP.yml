
services:
  php:
    build:
      context: ../
      dockerfile: .devcontainer/Dockerfile
    volumes:
      - ../:/workspace:cached
      - ./python_venv:/workspace/python_venv 
    command: sleep infinity
    ports:
      - "8000:8000"
      - "443:443"
    networks:
      - ldap-net
    depends_on:
      - mysql
      - lldap
    # environment:
    #   - DATABASE_URL=mysql://mariadb:mariadb@mysql:3306/mariadb?serverVersion=8.0

  mysql:
    image: mysql:8.0
    env_file:
      - .env
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./mysql-init:/docker-entrypoint-initdb.d:ro  # Monte les scripts d'init SQL
    networks:
      - ldap-net

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    environment:
      - PMA_ARBITRARY=1
      - PMA_HOST=mysql
      - PMA_USER=admin
      - PMA_PASSWORD=my_password
      - UPLOAD_LIMIT=20M
    ports:
      - "80:80"
    depends_on:
      - mysql
    networks:
      - ldap-net

  lldap:
    build:
      context: .
      dockerfile: Dockerfile.lldap
    environment:
      - LLDAP_DATABASE_URL=mysql://admin:my_password@mysql:3306/lldap?serverVersion=8.0
      - LLDAP_LDAP_BASE_DN=dc=gendarmerie,dc=defense,dc=gouv,dc=fr
      - LLDAP_JWT_SECRET=a7d3d31065ee6c940ae196378397e16881f8c525d0e7606f768756f121372d4f
      - LLDAP_LDAP_USER_DN=admin
      - LLDAP_LDAP_USER_PASS=my_password
      - LLDAP_LOG_LEVEL=debug
    volumes:
      - ./ldif:/app/data:rw  # Monte les LDIF
      - ./lldap-entrypoint.sh:/app/entrypoint.sh:ro  # Script d'entrée
      # Pas de volume /data car SQLite n'est pas utilisé
    entrypoint: ["/app/entrypoint.sh"]  # Exécute le script personnalisé
    ports:
      - "389:3890"  # LDAP sur 3890 (mappé à 389)
      - "17170:17170"  # Interface web
    depends_on:
      - mysql
    networks:
      - ldap-net
    # test depuis le host: ldapsearch -x -H ldap://localhost:389 -b "dc=example,dc=org" -D "uid=admin,ou=people,dc=example,dc=org" -w adminpass -s sub "(objectClass=*)"
    # test depuis contenr: ldapsearch -x -H ldap://lldap:3890 -b "dc=example,dc=org" -D "uid=admin,ou=people,dc=example,dc=org" -w adminpass -s sub "(objectClass=*)"

volumes:
  mysql-data:

networks:
  ldap-net:
    driver: bridge
      
