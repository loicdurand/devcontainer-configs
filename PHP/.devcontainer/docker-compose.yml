
services:
  php:
    build:
      context: ../
      dockerfile: .devcontainer/Dockerfile
    volumes:
      - ../:/workspace:cached
    command: sleep infinity
    ports:
      - "8000:8000"
      - "443:443"
    networks:
      - ldap-net
    depends_on:
      - mysql
      - lldap
    # environment:
    #   - DATABASE_URL=mysql://mariadb:mariadb@mysql:3306/mariadb?serverVersion=8.0

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: mariadb
      # MYSQL_DATABASE: mariadb
      MYSQL_USER: mariadb
      MYSQL_PASSWORD: mariadb
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./mysql-init:/docker-entrypoint-initdb.d:ro  # Monte les scripts d'init SQL
    networks:
      - ldap-net

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    environment:
      PMA_ARBITRARY: 1
      PMA_HOST: mysql
      PMA_USER: root
      PMA_PASSWORD: mariadb
      UPLOAD_LIMIT: 20M
    ports:
      - "80:80"
    depends_on:
      - mysql
    networks:
      - ldap-net

  lldap:
    build:
      context: .
      dockerfile: Dockerfile.lldap
    env_file:
      - .env
    environment:
      LLDAP_DATABASE_URL: "mysql://mariadb:mariadb@mysql:3306/lldap?serverVersion=8.0"
      LLDAP_LDAP_BASE_DN: "dc=example,dc=org"
      LLDAP_JWT_SECRET: "CHANGE_THIS_TO_A_RANDOM_STRING" #${LLDAP_JWT_SECRET}  # Change pour la sécurité: openssl rand -hex 32
      LLDAP_LDAP_USER_DN: "admin"
      LLDAP_LDAP_USER_PASS: "adminpass"
      LLDAP_LOG_LEVEL: "debug"  # Pour logs détaillés
    volumes:
      - ./ldif:/app/data:rw  # Monte les LDIF
      - ./lldap-entrypoint.sh:/app/entrypoint.sh:ro  # Script d'entrée
      # Pas de volume /data car SQLite n'est pas utilisé
    entrypoint: ["/app/entrypoint.sh"]  # Exécute le script personnalisé
    ports:
      - "389:3890"  # LDAP sur 3890 (mappé à 389)
      - "17170:17170"  # Interface web
    depends_on:
      - mysql
    networks:
      - ldap-net
    # test depuis le host: ldapsearch -x -H ldap://localhost:389 -b "dc=example,dc=org" -D "uid=admin,ou=people,dc=example,dc=org" -w adminpass -s sub "(objectClass=*)"
    # test depuis contenr: ldapsearch -x -H ldap://lldap:3890 -b "dc=example,dc=org" -D "uid=admin,ou=people,dc=example,dc=org" -w adminpass -s sub "(objectClass=*)"

volumes:
  mysql-data:

networks:
  ldap-net:
    driver: bridge
      
