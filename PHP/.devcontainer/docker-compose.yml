services:
  php:
    build:
      context: ../
      dockerfile: .devcontainer/Dockerfile
    volumes:
      - ../:/workspace:cached
      - ./apache.conf:/etc/apache2/sites-available/000-default.conf:ro
    networks:
      - php-net
    ports:
      - "8000:80"
    depends_on:
      - mysql

  sso:
    image: python:3.9
    build:
      context: ../
      dockerfile: .devcontainer/Dockerfile.sso
    volumes:
      - ./:/workspace:cached
    command: python3 /workspace/sso_server/sso_server.py &
    networks:
      - php-net
    depends_on:
      - mysql
      - openldap

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: my_password
      MYSQL_USER: admin
      MYSQL_PASSWORD: my_password
    volumes:
      - ./mysql-data:/var/lib/mysql:rw
      - ./mysql-init:/docker-entrypoint-initdb.d:ro
    networks:
      - php-net

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    environment:
      - PMA_ARBITRARY=1
      - PMA_HOST=mysql
      - PMA_USER=admin
      - PMA_PASSWORD=my_password
      - UPLOAD_LIMIT=20M
    depends_on:
      - mysql
    networks:
      - php-net

  openldap:
    container_name: openldap
    image: osixia/openldap:latest
    # Plus besoin de la commande apk add, l'image contient d�j� tout
    environment:
      # Configuration de base du domaine (ex: dc=mon-entreprise,dc=com)
      LDAP_ORGANISATION: "Mon Entreprise"
      LDAP_DOMAIN: "mon-entreprise.com"
      
      # Le mot de passe Admin !
      LDAP_ADMIN_PASSWORD: "my_password" 
      
      # Optionnel : active le debug pour voir ce qui se passe
      LDAP_LOG_LEVEL: "256"
    volumes:
      - openldap-data:/var/lib/ldap
      - openldap-config:/etc/ldap/slapd.d
      - ./ldifs:/docker-entrypoint-initdb.d:ro
    ports:
      - "389:389"
      - "636:636"
    networks:
      - php-net

  reverse-proxy:
    image: nginx:latest
    container_name: reverse-proxy
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
    - php
    - openldap
    - phpmyadmin
    networks:
      - php-net

volumes:
  mysql-data:
  openldap-data:
  openldap-config:

networks:
  php-net:
    driver: bridge
